"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const ix_1 = require("ix");
const apache_arrow_1 = require("apache-arrow");
const empty_1 = require("../assign/empty");
const recordbatches_1 = require("../merge/recordbatches");
const util_1 = require("../util");
async function* fullJoin(mergeOn, target, source) {
    const inners = ix_1.AsyncIterable.as(source instanceof apache_arrow_1.Table ? source.chunks : source);
    const outers = ix_1.AsyncIterable.as(target instanceof apache_arrow_1.Table ? target.chunks : target);
    const { newRows, recordBatches, outerFieldsMap } = await inners.reduce(fullJoinInner, { mergeOn, newRows: [], recordBatches: outers, recordBatchKeyMaps: [] });
    let numNewRows;
    let schema = null;
    let batch = null;
    for await (batch of recordBatches) {
        yield (batch = new apache_arrow_1.RecordBatch(schema || (schema = batch.schema), batch.data));
    }
    if (!batch || !schema || newRows.length <= 0) {
        return;
    }
    if ((numNewRows = newRows.map(([xs]) => xs.length).reduce((x, y) => x + y, 0)) <= 0) {
        return;
    }
    ([batch] = empty_1.assignNewEmptyColumns([...outerFieldsMap.entries()].map(([, [f]]) => f), new apache_arrow_1.RecordBatch(new apache_arrow_1.Schema([]), numNewRows, []), new Map(), batch, outerFieldsMap));
    let i = -1;
    for (const [idxs, inner] of newRows) {
        for (let j = -1, n = idxs.length; ++j < n;) {
            batch.set(++i, inner.get(idxs[j]));
        }
    }
    yield new apache_arrow_1.RecordBatch(schema, batch.data);
}
exports.fullJoin = fullJoin;
async function fullJoinInner(state, inner) {
    let newRowIndices;
    let newFields = [];
    let outerRecordBatchIndex = -1;
    let mergeOn = state.mergeOnKey;
    let recordBatch;
    let outerFieldsMap = state.outerFieldsMap;
    let innerFieldsMap = state.innerFieldsMap;
    let recordBatches = [];
    let recordBatchKeysMap;
    let recordBatchKeyMaps = state.recordBatchKeyMaps;
    if (outerFieldsMap && mergeOn) {
        newFields = util_1.findNewFields(outerFieldsMap, inner.schema.fields, mergeOn);
    }
    for await (const outer of state.recordBatches) {
        if (outer.schema === inner.schema) {
            recordBatches.push(outer);
            continue;
        }
        if (!mergeOn || !outerFieldsMap || !innerFieldsMap) {
            ([outerFieldsMap, innerFieldsMap, mergeOn] = createFullJoinState(state, outer, inner));
            if (mergeOn && !outerFieldsMap.has(mergeOn)) {
                continue;
            }
            if (!mergeOn || !innerFieldsMap.has(mergeOn)) {
                return state;
            }
            newFields = util_1.findNewFields(outerFieldsMap, inner.schema.fields, mergeOn);
        }
        ([recordBatch, outerFieldsMap] = empty_1.assignNewEmptyColumns(newFields, outer, outerFieldsMap, inner, innerFieldsMap));
        ([recordBatch, newRowIndices, recordBatchKeysMap] = recordbatches_1.mergeRecordBatches(mergeOn, recordBatchKeyMaps[++outerRecordBatchIndex], recordBatch, outerFieldsMap, inner, innerFieldsMap));
        recordBatches[outerRecordBatchIndex] = recordBatch;
        recordBatchKeyMaps[outerRecordBatchIndex] = recordBatchKeysMap;
        newRowIndices.length > 0 && state.newRows.push([newRowIndices, inner]);
    }
    if (outerRecordBatchIndex === -1) {
        recordBatches.push(inner);
    }
    state.recordBatches = ix_1.AsyncIterable.as(recordBatches);
    return state;
}
function createFullJoinState(state, outer, inner) {
    const outerFieldsMap = state.outerFieldsMap = util_1.assignFieldsMap(outer.schema.fields, state.outerFieldsMap);
    const innerFieldsMap = state.innerFieldsMap = util_1.assignFieldsMap(inner.schema.fields, state.innerFieldsMap);
    const mergeOn = state.mergeOnKey || (state.mergeOnKey = util_1.findMergeOnKey(state.mergeOn, outerFieldsMap));
    return [outerFieldsMap, innerFieldsMap, mergeOn];
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZnVsbC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9qb2lucy9mdWxsLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsMkJBQXFEO0FBQ3JELCtDQUEwRDtBQUUxRCwyQ0FBd0Q7QUFDeEQsMERBQTREO0FBQzVELGtDQUF5RTtBQUdsRSxLQUFLLFNBQVMsQ0FBQyxDQUFDLFFBQVEsQ0FDM0IsT0FBb0MsRUFDcEMsTUFBZ0QsRUFDaEQsTUFBZ0Q7SUFHaEQsTUFBTSxNQUFNLEdBQUcsa0JBQWMsQ0FBQyxFQUFFLENBQUMsTUFBTSxZQUFZLG9CQUFLLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQ25GLE1BQU0sTUFBTSxHQUFHLGtCQUFjLENBQUMsRUFBRSxDQUFDLE1BQU0sWUFBWSxvQkFBSyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUNuRixNQUFNLEVBQUUsT0FBTyxFQUFFLGFBQWEsRUFBRSxjQUFjLEVBQUUsR0FBRyxNQUFNLE1BQU0sQ0FBQyxNQUFNLENBQ2xFLGFBQWEsRUFBRSxFQUFFLE9BQU8sRUFBRSxPQUFPLEVBQUUsRUFBRSxFQUFFLGFBQWEsRUFBUSxNQUFNLEVBQUUsa0JBQWtCLEVBQUUsRUFBRSxFQUF5QixDQUFDLENBQUM7SUFFekgsSUFBSSxVQUFrQixDQUFDO0lBQ3ZCLElBQUksTUFBTSxHQUFrQixJQUFJLENBQUM7SUFDakMsSUFBSSxLQUFLLEdBQThCLElBQUksQ0FBQztJQUM1QyxJQUFJLEtBQUssRUFBRSxLQUFLLElBQUksYUFBYSxFQUFFO1FBQy9CLE1BQU0sQ0FBQyxLQUFLLEdBQUcsSUFBSSwwQkFBVyxDQUFDLE1BQU0sSUFBSSxDQUFDLE1BQU0sR0FBRyxLQUFLLENBQUMsTUFBTSxDQUFDLEVBQUUsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7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QUVELFNBQVMsbUJBQW1CLENBQ3hCLEtBQTBCLEVBQzFCLEtBQXlCLEVBQUUsS0FBcUI7SUFFaEQsTUFBTSxjQUFjLEdBQUcsS0FBSyxDQUFDLGNBQWMsR0FBRyxzQkFBZSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsTUFBTSxFQUFFLEtBQUssQ0FBQyxjQUFjLENBQUMsQ0FBQztJQUN6RyxNQUFNLGNBQWMsR0FBRyxLQUFLLENBQUMsY0FBYyxHQUFHLHNCQUFlLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxNQUFNLEVBQUUsS0FBSyxDQUFDLGNBQWMsQ0FBQyxDQUFDO0lBQ3pHLE1BQU0sT0FBTyxHQUFHLEtBQUssQ0FBQyxVQUFVLElBQUksQ0FBQyxLQUFLLENBQUMsVUFBVSxHQUFHLHFCQUFjLENBQU8sS0FBSyxDQUFDLE9BQU8sRUFBRSxjQUFjLENBQUMsQ0FBQyxDQUFDO0lBQzdHLE9BQU8sQ0FBQyxjQUFjLEVBQUUsY0FBYyxFQUFFLE9BQU8sQ0FBb0QsQ0FBQztBQUN4RyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQXN5bmNJdGVyYWJsZSBhcyBBc3luY0l0ZXJhYmxlWCB9IGZyb20gJ2l4JztcbmltcG9ydCB7IFNjaGVtYSwgVGFibGUsIFJlY29yZEJhdGNoIH0gZnJvbSAnYXBhY2hlLWFycm93JztcblxuaW1wb3J0IHsgYXNzaWduTmV3RW1wdHlDb2x1bW5zIH0gZnJvbSAnLi4vYXNzaWduL2VtcHR5JztcbmltcG9ydCB7IG1lcmdlUmVjb3JkQmF0Y2hlcyB9IGZyb20gJy4uL21lcmdlL3JlY29yZGJhdGNoZXMnO1xuaW1wb3J0IHsgZmluZE5ld0ZpZWxkcywgZmluZE1lcmdlT25LZXksIGFzc2lnbkZpZWxkc01hcCB9IGZyb20gJy4uL3V0aWwnO1xuaW1wb3J0IHsgVEtleSwgVEZpZWxkLCBUU2NoZW1hLCBLZXlzTWFwLCBGdWxsSm9pblN0YXRlLCBURmllbGRzTWFwIH0gZnJvbSAnLi4vaW50ZXJmYWNlcyc7XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiogZnVsbEpvaW48VCBleHRlbmRzIFRTY2hlbWEsIFIgZXh0ZW5kcyBUU2NoZW1hPihcbiAgICBtZXJnZU9uOiBURmllbGQ8VCAmIFI+IHwgVEtleTxUICYgUj4sXG4gICAgdGFyZ2V0OiBUYWJsZTxUPiB8IEFzeW5jSXRlcmFibGU8UmVjb3JkQmF0Y2g8VD4+LFxuICAgIHNvdXJjZTogVGFibGU8Uj4gfCBBc3luY0l0ZXJhYmxlPFJlY29yZEJhdGNoPFI+PlxuKTogQXN5bmNJdGVyYWJsZUl0ZXJhdG9yPFJlY29yZEJhdGNoPFQgJiBSPj4ge1xuICAgIFxuICAgIGNvbnN0IGlubmVycyA9IEFzeW5jSXRlcmFibGVYLmFzKHNvdXJjZSBpbnN0YW5jZW9mIFRhYmxlID8gc291cmNlLmNodW5rcyA6IHNvdXJjZSk7XG4gICAgY29uc3Qgb3V0ZXJzID0gQXN5bmNJdGVyYWJsZVguYXModGFyZ2V0IGluc3RhbmNlb2YgVGFibGUgPyB0YXJnZXQuY2h1bmtzIDogdGFyZ2V0KTtcbiAgICBjb25zdCB7IG5ld1Jvd3MsIHJlY29yZEJhdGNoZXMsIG91dGVyRmllbGRzTWFwIH0gPSBhd2FpdCBpbm5lcnMucmVkdWNlPFJlY29yZEJhdGNoPFI+LCBGdWxsSm9pblN0YXRlPFQsIFI+PihcbiAgICAgICAgZnVsbEpvaW5Jbm5lciwgeyBtZXJnZU9uLCBuZXdSb3dzOiBbXSwgcmVjb3JkQmF0Y2hlczogPGFueT4gb3V0ZXJzLCByZWNvcmRCYXRjaEtleU1hcHM6IFtdIH0gYXMgRnVsbEpvaW5TdGF0ZTxULCBSPik7XG5cbiAgICBsZXQgbnVtTmV3Um93czogbnVtYmVyO1xuICAgIGxldCBzY2hlbWE6IFNjaGVtYSB8IG51bGwgPSBudWxsO1xuICAgIGxldCBiYXRjaDogUmVjb3JkQmF0Y2g8VCAmIFI+IHwgbnVsbCA9IG51bGw7XG4gICAgZm9yIGF3YWl0IChiYXRjaCBvZiByZWNvcmRCYXRjaGVzKSB7XG4gICAgICAgIHlpZWxkIChiYXRjaCA9IG5ldyBSZWNvcmRCYXRjaChzY2hlbWEgfHwgKHNjaGVtYSA9IGJhdGNoLnNjaGVtYSksIGJhdGNoLmRhdGEpKTtcbiAgICB9XG5cbiAgICBpZiAoIWJhdGNoIHx8ICFzY2hlbWEgfHwgbmV3Um93cy5sZW5ndGggPD0gMCkgeyByZXR1cm47IH1cbiAgICBpZiAoKG51bU5ld1Jvd3MgPSBuZXdSb3dzLm1hcCgoW3hzXSkgPT4geHMubGVuZ3RoKS5yZWR1Y2UoKHgsIHkpID0+IHggKyB5LCAwKSkgPD0gMCkgeyByZXR1cm47IH1cblxuICAgIChbYmF0Y2hdID0gYXNzaWduTmV3RW1wdHlDb2x1bW5zPFQsIFQgJiBSPihcbiAgICAgICAgWy4uLm91dGVyRmllbGRzTWFwIS5lbnRyaWVzKCldLm1hcCgoWywgW2ZdXSkgPT4gZiksXG4gICAgICAgIG5ldyBSZWNvcmRCYXRjaChuZXcgU2NoZW1hKFtdKSwgbnVtTmV3Um93cywgW10pLCBuZXcgTWFwKCksXG4gICAgICAgIGJhdGNoLCBvdXRlckZpZWxkc01hcCEsXG4gICAgKSk7XG5cbiAgICBsZXQgaSA9IC0xO1xuICAgIGZvciAoY29uc3QgW2lkeHMsIGlubmVyXSBvZiBuZXdSb3dzKSB7XG4gICAgICAgIGZvciAobGV0IGogPSAtMSwgbiA9IGlkeHMubGVuZ3RoOyArK2ogPCBuOykge1xuICAgICAgICAgICAgYmF0Y2guc2V0KCsraSwgaW5uZXIuZ2V0KGlkeHNbal0pISk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICB5aWVsZCBuZXcgUmVjb3JkQmF0Y2goc2NoZW1hLCBiYXRjaC5kYXRhKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gZnVsbEpvaW5Jbm5lcjxUIGV4dGVuZHMgVFNjaGVtYSwgUiBleHRlbmRzIFRTY2hlbWE+KFxuICAgIHN0YXRlOiBGdWxsSm9pblN0YXRlPFQsIFI+LFxuICAgIGlubmVyOiBSZWNvcmRCYXRjaDxSPlxuKSB7XG5cbiAgICBsZXQgbmV3Um93SW5kaWNlczogSW50MzJBcnJheTtcbiAgICBsZXQgbmV3RmllbGRzOiBURmllbGQ8Uj5bXSA9IFtdO1xuXG4gICAgbGV0IG91dGVyUmVjb3JkQmF0Y2hJbmRleCA9IC0xO1xuICAgIGxldCBtZXJnZU9uID0gc3RhdGUubWVyZ2VPbktleTtcbiAgICBsZXQgcmVjb3JkQmF0Y2g6IFJlY29yZEJhdGNoPFQgJiBSPjtcbiAgICBsZXQgb3V0ZXJGaWVsZHNNYXAgPSBzdGF0ZS5vdXRlckZpZWxkc01hcDtcbiAgICBsZXQgaW5uZXJGaWVsZHNNYXAgPSBzdGF0ZS5pbm5lckZpZWxkc01hcDtcbiAgICBcbiAgICBsZXQgcmVjb3JkQmF0Y2hlcyA9IFtdO1xuICAgIGxldCByZWNvcmRCYXRjaEtleXNNYXA6IEtleXNNYXA7XG4gICAgbGV0IHJlY29yZEJhdGNoS2V5TWFwcyA9IHN0YXRlLnJlY29yZEJhdGNoS2V5TWFwcztcbiAgICBcbiAgICBpZiAob3V0ZXJGaWVsZHNNYXAgJiYgbWVyZ2VPbikge1xuICAgICAgICBuZXdGaWVsZHMgPSBmaW5kTmV3RmllbGRzKG91dGVyRmllbGRzTWFwLCBpbm5lci5zY2hlbWEuZmllbGRzIGFzIFRGaWVsZDxSPltdLCBtZXJnZU9uKTtcbiAgICB9XG5cbiAgICBmb3IgYXdhaXQgKGNvbnN0IG91dGVyIG9mIHN0YXRlLnJlY29yZEJhdGNoZXMpIHtcblxuICAgICAgICBpZiAob3V0ZXIuc2NoZW1hID09PSBpbm5lci5zY2hlbWEpIHtcbiAgICAgICAgICAgIHJlY29yZEJhdGNoZXMucHVzaChvdXRlcik7XG4gICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghbWVyZ2VPbiB8fCAhb3V0ZXJGaWVsZHNNYXAgfHwgIWlubmVyRmllbGRzTWFwKSB7XG4gICAgICAgICAgICAoW291dGVyRmllbGRzTWFwLCBpbm5lckZpZWxkc01hcCwgbWVyZ2VPbl0gPSBjcmVhdGVGdWxsSm9pblN0YXRlPFQsIFI+KHN0YXRlLCBvdXRlciwgaW5uZXIpKTtcbiAgICAgICAgICAgIGlmIChtZXJnZU9uICYmICFvdXRlckZpZWxkc01hcC5oYXMobWVyZ2VPbiBhcyBrZXlvZiBUKSkgeyBjb250aW51ZTsgfVxuICAgICAgICAgICAgaWYgKCFtZXJnZU9uIHx8ICFpbm5lckZpZWxkc01hcC5oYXMobWVyZ2VPbiBhcyBrZXlvZiBSKSkgeyByZXR1cm4gc3RhdGU7IH1cbiAgICAgICAgICAgIG5ld0ZpZWxkcyA9IGZpbmROZXdGaWVsZHMob3V0ZXJGaWVsZHNNYXAsIGlubmVyLnNjaGVtYS5maWVsZHMgYXMgVEZpZWxkPFI+W10sIG1lcmdlT24pO1xuICAgICAgICB9XG5cbiAgICAgICAgKFtyZWNvcmRCYXRjaCwgb3V0ZXJGaWVsZHNNYXBdID0gYXNzaWduTmV3RW1wdHlDb2x1bW5zPFQgJiBSLCBSPihuZXdGaWVsZHMsIG91dGVyLCBvdXRlckZpZWxkc01hcCwgaW5uZXIsIGlubmVyRmllbGRzTWFwKSk7XG5cbiAgICAgICAgKFtyZWNvcmRCYXRjaCwgbmV3Um93SW5kaWNlcywgcmVjb3JkQmF0Y2hLZXlzTWFwXSA9IG1lcmdlUmVjb3JkQmF0Y2hlczxUICYgUiwgUj4oXG4gICAgICAgICAgICBtZXJnZU9uLFxuICAgICAgICAgICAgcmVjb3JkQmF0Y2hLZXlNYXBzWysrb3V0ZXJSZWNvcmRCYXRjaEluZGV4XSxcbiAgICAgICAgICAgIHJlY29yZEJhdGNoLCBvdXRlckZpZWxkc01hcCwgaW5uZXIsIGlubmVyRmllbGRzTWFwXG4gICAgICAgICkpO1xuXG4gICAgICAgIHJlY29yZEJhdGNoZXNbb3V0ZXJSZWNvcmRCYXRjaEluZGV4XSA9IHJlY29yZEJhdGNoO1xuICAgICAgICByZWNvcmRCYXRjaEtleU1hcHNbb3V0ZXJSZWNvcmRCYXRjaEluZGV4XSA9IHJlY29yZEJhdGNoS2V5c01hcDtcbiAgICAgICAgbmV3Um93SW5kaWNlcy5sZW5ndGggPiAwICYmIHN0YXRlLm5ld1Jvd3MucHVzaChbbmV3Um93SW5kaWNlcywgPGFueT4gaW5uZXIgYXMgUmVjb3JkQmF0Y2g8VCAmIFI+XSk7XG4gICAgfVxuXG4gICAgaWYgKG91dGVyUmVjb3JkQmF0Y2hJbmRleCA9PT0gLTEpIHtcbiAgICAgICAgcmVjb3JkQmF0Y2hlcy5wdXNoKDxhbnk+IGlubmVyIGFzIFJlY29yZEJhdGNoPFQgJiBSPik7XG4gICAgfVxuXG4gICAgc3RhdGUucmVjb3JkQmF0Y2hlcyA9IEFzeW5jSXRlcmFibGVYLmFzKHJlY29yZEJhdGNoZXMpO1xuXG4gICAgcmV0dXJuIHN0YXRlO1xufVxuXG5mdW5jdGlvbiBjcmVhdGVGdWxsSm9pblN0YXRlPFQgZXh0ZW5kcyBUU2NoZW1hLCBSIGV4dGVuZHMgVFNjaGVtYT4oXG4gICAgc3RhdGU6IEZ1bGxKb2luU3RhdGU8VCwgUj4sXG4gICAgb3V0ZXI6IFJlY29yZEJhdGNoPFQgJiBSPiwgaW5uZXI6IFJlY29yZEJhdGNoPFI+XG4pIHtcbiAgICBjb25zdCBvdXRlckZpZWxkc01hcCA9IHN0YXRlLm91dGVyRmllbGRzTWFwID0gYXNzaWduRmllbGRzTWFwKG91dGVyLnNjaGVtYS5maWVsZHMsIHN0YXRlLm91dGVyRmllbGRzTWFwKTtcbiAgICBjb25zdCBpbm5lckZpZWxkc01hcCA9IHN0YXRlLmlubmVyRmllbGRzTWFwID0gYXNzaWduRmllbGRzTWFwKGlubmVyLnNjaGVtYS5maWVsZHMsIHN0YXRlLmlubmVyRmllbGRzTWFwKTtcbiAgICBjb25zdCBtZXJnZU9uID0gc3RhdGUubWVyZ2VPbktleSB8fCAoc3RhdGUubWVyZ2VPbktleSA9IGZpbmRNZXJnZU9uS2V5PFQsIFI+KHN0YXRlLm1lcmdlT24sIG91dGVyRmllbGRzTWFwKSk7XG4gICAgcmV0dXJuIFtvdXRlckZpZWxkc01hcCwgaW5uZXJGaWVsZHNNYXAsIG1lcmdlT25dIGFzIFtURmllbGRzTWFwPFQgJiBSPiwgVEZpZWxkc01hcDxSPiwgVEtleTxUIHwgUj5dO1xufVxuIl19